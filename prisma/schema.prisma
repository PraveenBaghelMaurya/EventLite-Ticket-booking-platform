generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  name         String?
  email        String   @unique
  phone        String?  @unique
  passwordHash String?
  avatar       String?
  role         UserRole @default(USER)

  googleId   String? @unique
  facebookId String? @unique

  refreshToken String?
  accessToken  String?

  events        Event[]        @relation("EventOrganizer")
  tickets       Ticket[]
  bookings      Booking[]
  payments      Payment[]
  notifications Notification[]
  auditLogs     AuditLog[]
  fileUploads   FileUpload[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Event {
  id               Int     @id @default(autoincrement())
  title            String
  description      String?
  shortDescription String?

  venue      String?
  street     String?
  city       String?
  state      String?
  country    String?
  postalCode String?

  startDate DateTime
  endDate   DateTime
  doorTime  DateTime?

  image  String?
  images String[]

  price            Float @default(0)
  capacity         Int
  availableTickets Int

  status     EventStatus @default(DRAFT)
  isFeatured Boolean     @default(false)
  isPublic   Boolean     @default(true)

  organizer   User @relation("EventOrganizer", fields: [organizerId], references: [id], onDelete: Cascade)
  organizerId Int

  category   Category? @relation(fields: [categoryId], references: [id])
  categoryId Int?

  tickets  Ticket[]
  bookings Booking[]
  viewers  EventViewer[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([startDate])
  @@index([status])
  @@index([organizerId])
  @@index([categoryId])
  @@map("events")
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  slug        String  @unique
  image       String?

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model Ticket {
  id       Int    @id @default(autoincrement())
  ticketId String @unique
  qrCode   String @unique

  price      Float
  seatNumber String?
  status     TicketStatus @default(AVAILABLE)

  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId Int

  booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId Int?

  user   User? @relation(fields: [userId], references: [id])
  userId Int?

  validatedAt DateTime?
  validatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@index([qrCode])
  @@map("tickets")
}

model Booking {
  id          Int    @id @default(autoincrement())
  bookingCode String @unique

  totalAmount   Float
  ticketCount   Int
  attendeeEmail String
  attendeeName  String?

  user   User? @relation(fields: [userId], references: [id])
  userId Int?

  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId Int

  payment   Payment? @relation(fields: [paymentId], references: [id])
  paymentId Int?     @unique

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime

  @@index([userId])
  @@index([eventId])
  @@index([paymentId])
  @@index([bookingCode])
  @@index([expiresAt])
  @@map("bookings")
}

model Payment {
  id Int @id @default(autoincrement())

  amount           Float
  currency         currencyCode  @default(INR)
  status           PaymentStatus @default(PENDING)
  stripePaymentId  String?       @unique
  stripeCustomerId String?

  paymentMethod PaymentMethod?
  last4         String?

  refundAmount Float?  @default(0)
  refundReason String?

  user   User @relation(fields: [userId], references: [id])
  userId Int

  booking Booking?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripePaymentId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Notification {
  id      Int              @id @default(autoincrement())
  type    NotificationType
  title   String
  message String
  isRead  Boolean          @default(false)

  metadata Json?

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id          Int     @id @default(autoincrement())
  action      String
  resource    String
  resourceId  String
  description String?

  oldData Json?
  newData Json?

  ipAddress String?
  userAgent String?

  user   User? @relation(fields: [userId], references: [id])
  userId Int?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

model EventViewer {
  id        Int     @id @default(autoincrement())
  eventId   Int
  userId    String?
  socketId  String
  userAgent String?
  ipAddress String?

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, socketId])
  @@index([eventId])
  @@index([updatedAt])
  @@map("event_viewers")
}

model FileUpload {
  id Int @id @default(autoincrement())

  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  cloudinaryId String? @unique

  description String?
  tags        String[]

  uploadedBy   User? @relation(fields: [uploadedById], references: [id])
  uploadedById Int?

  createdAt DateTime @default(now())

  @@index([uploadedById])
  @@index([createdAt])
  @@map("file_uploads")
}

model SystemSetting {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  value       String
  description String?
  isPublic    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum TicketStatus {
  AVAILABLE
  RESERVED
  BOOKED
  USED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum NotificationType {
  BOOKING_CONFIRMATION
  EVENT_REMINDER
  TICKET_UPDATE
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  EVENT_CANCELLED
  NEW_EVENT
}

enum currencyCode {
  INR
  USD
  EUR
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  UPI
}
